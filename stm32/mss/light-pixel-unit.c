#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>


uint32_t data[256] = {
0x0000000c, 0x2b3bc669, 0x039c51ff, 0x2250ec29, 0x2668baab, 0x0f96fbe3, 0x0a307cc2, 0x02a7f81b, 
0x0f45e78d, 0x3bb55a2e, 0x131a339f, 0x264f9a66, 0x29900db7, 0x00000000, 0x00000000, 0x00000000, 
0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 
0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,

0x00000009, 0x118c58a3, 0x0ad1255d, 0x082b1758, 0x174c5ed4, 0x2d5cb2cd, 0x06369bb4, 0x22a6110e, 
0x2c107441, 0x290d3ddc, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 
0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 
0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 

0x00000007, 0x043a70e9, 0x01f4a141, 0x070dfc67, 0x11f7017e, 0x14b9eadc, 0x1b5f968f, 0x21c05c2a, 
0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 
0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 
0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 

0x00000013, 0x1764b03b, 0x37da32af, 0x29e754ec, 0x18c7db5c, 0x08101afe, 0x1a18fbfa, 0x35533afb, 
0x294dd1e6, 0x00293c7c, 0x3ca575d8, 0x2df06189, 0x0fcf5cbb, 0x3544990f, 0x04afb1eb, 0x2788b305, 
0x2f7bf700, 0x274aa13a, 0x172fca0b, 0x165fd048, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 
0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 

0x00000014, 0x123f64bd, 0x10fd231e, 0x35471c7b, 0x2b25c514, 0x1b9e5ac5, 0x0af34b79, 0x3b193b70, 
0x33262411, 0x04f109dc, 0x0553d4ac, 0x0f961b10, 0x05783b33, 0x3e6ee350, 0x32444715, 0x0ae7bb6f, 
0x211119ba, 0x3cd87df5, 0x385ee11a, 0x08e77f23, 0x17c029f8, 0x00000000, 0x00000000, 0x00000000, 
0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 

0x00000019, 0x25221b13, 0x2daaca4e, 0x1f429832, 0x09c0e079, 0x226a3d34, 0x2de65f4e, 0x13bdfacb, 
0x036505ac, 0x2436212b, 0x0d511a55, 0x1515be70, 0x0dab733b, 0x08275cd3, 0x39b094b3, 0x0d7ce2f0, 
0x1f229e4f, 0x39951549, 0x17ed824e, 0x2d4a0870, 0x3ea3b28a, 0x114e5448, 0x34d00abc, 0x2ea90e18, 
0x3d4044ac, 0x12d9f38e, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 

0x0000001d, 0x3a65d72d, 0x14dd0942, 0x1f2806c4, 0x119dafcd, 0x351d847f, 0x216fadd4, 0x3bb647de, 
0x31941cec, 0x2253c430, 0x17b62023, 0x342d6cfb, 0x25900704, 0x3fa3ec0b, 0x05ce20ba, 0x1c34c33e, 
0x1028f1ec, 0x36c86733, 0x1dbe9950, 0x0d1ae314, 0x3e9dd934, 0x3fbc5ea0, 0x2f9110a8, 0x07b10594, 
0x2009beb4, 0x25e54478, 0x17d74969, 0x073623d0, 0x28d1da69, 0x2b537e4c, 0x00000000, 0x00000000, 

0x0000000e, 0x0bf35125, 0x1d9b4884, 0x1a993a94, 0x17da3199, 0x34863257, 0x0222ee9b, 0x35e5e9e5, 
0x312ecf08, 0x2fabe9e2, 0x22f15360, 0x2d52d2b2, 0x268685fa, 0x02a1d835, 0x2744d466, 0x00000000, 
0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 
0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
};

uint8_t light_pixel_rfd = 1;
uint8_t light_pixel_raddr = 0;

#define light_pixel_data data[light_pixel_raddr]

struct light_pixel_info {
	/* max 124 */
	uint8_t number;
	uint8_t value[124];
	struct {
		uint16_t x;
		uint16_t y;
	} coord[124];
};

void light_pixel_check(struct light_pixel_info *lpi)
{
	uint8_t n, i, zone;
	uint32_t tmp;

	/* line 0:even line 1:odd */
	static uint8_t is_odd = 0;

	lpi->number = 0;
	for (zone = 0; zone < 4; zone++) {
		uint8_t base_addr;

		base_addr = is_odd*128 + zone*32;
		/* data valid */
		while (!light_pixel_rfd);
		light_pixel_raddr = base_addr;

		if (n = light_pixel_data) {
			if (n>31) n = 31;
			for (i = 0; i < n; i++) {
				light_pixel_raddr = base_addr + 1 + i;
				tmp = light_pixel_data;
				/* 2bit(null)+11bit(x)+11bit(y)+8bit(value) */
				lpi->value[lpi->number + i] = (uint8_t)tmp;
				lpi->coord[lpi->number + i].y = tmp>>8 & 0x000007ff;
				lpi->coord[lpi->number + i].x = tmp>>19;
			}
			lpi->number += n;
		}
	}
	is_odd = !is_odd;
}

int main(void)
{
	int i;
	struct light_pixel_info lpi;

	light_pixel_check(&lpi);
	printf("count=%d\n", lpi.number);

	for (i = 0; i < lpi.number; i++) {
		if (!(i % 16)) {
			puts("");
		}
		printf("0x%03x ", lpi.coord[i].x);
	}
	puts("");
	

	light_pixel_check(&lpi);
	printf("count=%d\n", lpi.number);

	for (i = 0; i < lpi.number; i++) {
		if (!(i % 16)) {
			puts("");
		}
		printf("0x%02x ", lpi.value[i]);
	}
	puts("");
	return 0;
}
